<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-color: #0071e3;
            --success-color: #34c759;
            --danger-color: #ff3b30;
            --warning-color: #ff9500;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --card-bg: rgba(255, 255, 255, 0.8);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
                --bg-secondary: #1d1d1f;
                --text-primary: #f5f5f7;
                --text-secondary: #86868b;
                --accent-color: #0a84ff;
                --success-color: #30d158;
                --danger-color: #ff453a;
                --warning-color: #ff9f0a;
                --glass-bg: rgba(29, 29, 31, 0.7);
                --glass-border: rgba(255, 255, 255, 0.1);
                --shadow-color: rgba(0, 0, 0, 0.5);
                --card-bg: rgba(29, 29, 31, 0.8);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            transition: background 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 113, 227, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(120, 40, 200, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(52, 199, 89, 0.1) 0%, transparent 50%);
            animation: gradient-shift 25s ease infinite;
            z-index: -1;
        }

        @keyframes gradient-shift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(5%, 5%) rotate(120deg); }
            66% { transform: translate(-5%, 5%) rotate(240deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: 30px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px var(--shadow-color);
            padding: 50px;
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 50px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--glass-border);
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .user-info {
            text-align: right;
        }

        .user-info p {
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .logout-btn {
            padding: 10px 24px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 35px;
            flex-wrap: wrap;
            animation: fadeIn 1s ease 0.2s both;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95em;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 14px 16px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 1em;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
            transform: translateY(-2px);
        }

        .btn-primary {
            padding: 12px 32px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 113, 227, 0.4);
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
            animation: fadeIn 1s ease 0.3s both;
        }

        .stat-card {
            padding: 28px;
            border-radius: 20px;
            color: white;
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(180%);
            box-shadow: 0 8px 24px var(--shadow-color);
            border: 1px solid var(--glass-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.9;
            border-radius: 20px;
            z-index: -1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 32px var(--shadow-color);
        }

        .stat-card.blue::before {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.green::before {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.orange::before {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .stat-card h3 {
            font-size: 0.85em;
            margin-bottom: 12px;
            opacity: 0.95;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 2.8em;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .student-table-container {
            overflow-x: auto;
            margin-bottom: 35px;
            border-radius: 16px;
            background: var(--card-bg);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 24px var(--shadow-color);
            animation: fadeIn 1s ease 0.5s both;
        }

        .student-table {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
        }

        .student-table thead {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .student-table th,
        .student-table td {
            padding: 18px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        .student-table th {
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .student-table tbody tr {
            transition: all 0.3s ease;
        }

        .student-table tbody tr:hover {
            background: rgba(128, 128, 128, 0.05);
            transform: scale(1.01);
        }

        .student-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-color);
        }

        .student-table input[type="number"] {
            width: 90px;
            padding: 8px 10px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .student-table input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            animation: fadeIn 1s ease 0.6s both;
        }

        .btn-success {
            padding: 14px 32px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(52, 199, 89, 0.4);
        }

        .btn-secondary {
            padding: 14px 32px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            background: var(--bg-primary);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .message {
            display: none;
            padding: 18px 24px;
            border-radius: 14px;
            margin-bottom: 25px;
            font-weight: 500;
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.success {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .message.error {
            background: rgba(255, 59, 48, 0.15);
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .message.show {
            display: block;
        }

        .topper-card {
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(180%);
            color: var(--text-primary);
            padding: 32px;
            border-radius: 20px;
            margin-bottom: 35px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 24px var(--shadow-color);
            position: relative;
            overflow: hidden;
            animation: fadeIn 1s ease 0.4s both;
        }

        .topper-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 45, 85, 0.1) 100%);
            z-index: -1;
        }

        .topper-card h2 {
            margin-bottom: 20px;
            font-size: 1.6em;
            font-weight: 700;
            background: linear-gradient(135deg, #ff9500, #ff2d55);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .topper-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
        }

        .topper-item {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            padding: 14px 18px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .topper-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .topper-item strong {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .topper-item span {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1em;
        }

        .no-auth {
            text-align: center;
            padding: 80px 40px;
            animation: fadeIn 1s ease;
        }

        .no-auth h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 2em;
        }

        .no-auth p {
            color: var(--text-secondary);
            margin-bottom: 35px;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 25px;
            }
            
            .filters {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .user-info {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="authRequired" class="no-auth" style="display: none;">
            <h2>üîí Authentication Required</h2>
            <p>Please log in to access the admin panel.</p>
            <a href="index.html" class="btn-primary">Go to Login</a>
        </div>

        <div id="adminPanel" style="display: none;">
            <div class="header">
                <div>
                    <h1>üë®‚Äçüè´ Faculty Admin Panel</h1>
                    <p style="color: #666; margin-top: 10px;">Manage Student Records</p>
                </div>
                <div class="user-info">
                    <p>Welcome, <strong id="facultyName">Faculty</strong></p>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <div id="messageBox" class="message"></div>

            <div class="topper-card">
                <h2>üèÜ Class Topper</h2>
                <div class="topper-info" id="topperInfo">
                    <div class="topper-item">
                        <strong>Name</strong>
                        <span id="topperName">-</span>
                    </div>
                    <div class="topper-item">
                        <strong>Roll Number</strong>
                        <span id="topperRoll">-</span>
                    </div>
                    <div class="topper-item">
                        <strong>CGPA</strong>
                        <span id="topperCGPA">-</span>
                    </div>
                    <div class="topper-item">
                        <strong>Attendance</strong>
                        <span id="topperAttendance">-</span>
                    </div>
                    <div class="topper-item">
                        <strong>Grade</strong>
                        <span id="topperGrade">-</span>
                    </div>
                </div>
            </div>

            <div class="stats-cards">
                <div class="stat-card blue">
                    <h3>Total Students</h3>
                    <div class="value" id="totalStudents">0</div>
                </div>
                <div class="stat-card green">
                    <h3>Selected Students</h3>
                    <div class="value" id="selectedCount">0</div>
                </div>
                <div class="stat-card orange">
                    <h3>Average CGPA</h3>
                    <div class="value" id="avgCGPA">0.0</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="courseFilter">Filter by Course</label>
                    <select id="courseFilter" onchange="filterStudents()">
                        <option value="">All Courses</option>
                        <option value="B.Tech">B.Tech</option>
                        <option value="B.Sc">B.Sc</option>
                        <option value="M.Tech">M.Tech</option>
                        <option value="M.Sc">M.Sc</option>
                        <option value="MBA">MBA</option>
                        <option value="BBA">BBA</option>
                        <option value="BCA">BCA</option>
                        <option value="MCA">MCA</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="yearFilter">Filter by Year</label>
                    <select id="yearFilter" onchange="filterStudents()">
                        <option value="">All Years</option>
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchFilter">Search by Name/Roll</label>
                    <input type="text" id="searchFilter" placeholder="Search..." oninput="filterStudents()">
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-success" onclick="saveMarks()">üíæ Save Marks for Selected Students</button>
                <button class="btn-secondary" onclick="selectAll()">‚òëÔ∏è Select All</button>
                <button class="btn-secondary" onclick="deselectAll()">‚òê Deselect All</button>
            </div>

            <div class="student-table-container">
                <table class="student-table">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Course</th>
                            <th>Year</th>
                            <th>Current Marks</th>
                            <th>New Marks</th>
                            <th>Current CGPA</th>
                            <th>New CGPA</th>
                            <th>Attendance</th>
                            <th>Grade</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        <!-- Students will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allStudents = [];
        let filteredStudents = [];

        // Check authentication on page load
        window.onload = function() {
            console.log('Admin page loaded, checking authentication...');
            const facultyId = sessionStorage.getItem('facultyId');
            const facultyName = sessionStorage.getItem('facultyName');
            console.log('Faculty ID from session:', facultyId);
            console.log('Faculty Name from session:', facultyName);

            if (!facultyId) {
                console.log('No faculty ID found, showing authentication required message');
                document.getElementById('authRequired').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            } else {
                console.log('Faculty authenticated, loading admin panel');
                document.getElementById('authRequired').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('facultyName').textContent = facultyName || 'Faculty';
                loadStudents();
                loadTopper();
            }
        };

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        async function loadStudents() {
            console.log('Loading students...');
            try {
                const response = await fetch('/api/students');
                console.log('Students API response status:', response.status);
                const data = await response.json();
                console.log('Students data received:', data);
                
                if (response.ok) {
                    allStudents = data.students;
                    filteredStudents = [...allStudents];
                    displayStudents();
                    updateStats();
                    console.log('Students loaded successfully:', allStudents.length);
                } else {
                    console.error('Failed to load students:', data);
                    showMessage('Error loading students', 'error');
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showMessage('Error loading students: ' + error.message, 'error');
            }
        }

        async function loadTopper() {
            try {
                const response = await fetch('/api/topper');
                const data = await response.json();
                
                if (response.ok && data.topper) {
                    document.getElementById('topperName').textContent = data.topper.name;
                    document.getElementById('topperRoll').textContent = data.topper.roll_no;
                    document.getElementById('topperCGPA').textContent = data.topper.cgpa;
                    document.getElementById('topperAttendance').textContent = data.topper.attendance + '%';
                    document.getElementById('topperGrade').textContent = data.topper.grade;
                }
            } catch (error) {
                console.error('Error loading topper:', error);
            }
        }

        function displayStudents() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';

            filteredStudents.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="student-checkbox" data-roll="${student.roll_no}" onchange="updateSelectedCount()"></td>
                    <td>${student.roll_no}</td>
                    <td>${student.name}</td>
                    <td>${student.degree}</td>
                    <td>${student.year_of_registration}</td>
                    <td>${student.marks}</td>
                    <td><input type="number" class="new-marks" data-roll="${student.roll_no}" min="0" max="100" step="0.1"></td>
                    <td>${student.cgpa}</td>
                    <td><input type="number" class="new-cgpa" data-roll="${student.roll_no}" min="0" max="10" step="0.01"></td>
                    <td>${student.attendance}%</td>
                    <td><span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px;">${student.grade}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterStudents() {
            const courseFilter = document.getElementById('courseFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredStudents = allStudents.filter(student => {
                const courseMatch = !courseFilter || student.degree === courseFilter;
                const yearMatch = !yearFilter || student.year_of_registration.toString() === yearFilter;
                const searchMatch = !searchFilter || 
                    student.name.toLowerCase().includes(searchFilter) || 
                    student.roll_no.toLowerCase().includes(searchFilter);

                return courseMatch && yearMatch && searchMatch;
            });

            displayStudents();
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalStudents').textContent = filteredStudents.length;
            
            if (filteredStudents.length > 0) {
                const avgCGPA = filteredStudents.reduce((sum, s) => sum + s.cgpa, 0) / filteredStudents.length;
                document.getElementById('avgCGPA').textContent = avgCGPA.toFixed(2);
            } else {
                document.getElementById('avgCGPA').textContent = '0.0';
            }
        }

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.student-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = selected;
        }

        function selectAll() {
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }

        function deselectAll() {
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        async function saveMarks() {
            const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showMessage('Please select at least one student', 'error');
                return;
            }

            const updates = [];
            selectedCheckboxes.forEach(checkbox => {
                const rollNo = checkbox.dataset.roll;
                const newMarks = document.querySelector(`.new-marks[data-roll="${rollNo}"]`).value;
                const newCGPA = document.querySelector(`.new-cgpa[data-roll="${rollNo}"]`).value;

                if (newMarks || newCGPA) {
                    updates.push({
                        roll_no: rollNo,
                        marks: newMarks ? parseFloat(newMarks) : null,
                        cgpa: newCGPA ? parseFloat(newCGPA) : null
                    });
                }
            });

            if (updates.length === 0) {
                showMessage('Please enter marks or CGPA for selected students', 'error');
                return;
            }

            try {
                const response = await fetch('/api/update-marks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ updates: updates })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(`Successfully updated ${data.updated_count} student(s)`, 'success');
                    loadStudents();
                    loadTopper();
                    deselectAll();
                } else {
                    showMessage('Error updating marks', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error updating marks', 'error');
            }
        }

        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `message ${type} show`;
            
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
